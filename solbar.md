# ソルバーを使った多変数フィッティング

## データ
次のようなデータを関数で表すことを考える

|x|y
| --- | --- |
|0|8.02
|0.1|7.95
|0.2|7.86
|0.3|7.63
|0.4|7.48
|0.5|7.17
|0.6|6.72
|0.7|5.54
|0.8|4.74
|0.9|3.18
|1|1.99

<img src=img/sol1.png width=600>

## 関数

どのような関数でフィッティングするかを考える  

直線 $a+bx$ では表せなさそうなので、  
2次関数 $a+bx+cx^2$ で表すことを考えよう。

シート内に a, b, c を入力するセルを作成する  
(下記 G3, G4, G5)  
最初は適当な値を入れておく。

<img src=img/sol2.png width=600>

データ列 (F列 緑) のとなりに、考えた関数 ( $a+bx+cx^2$ ) の値が表示されるようにする。  
a, b, c の値と x の値 (E10) を参照し、
例えば、上記 G9 セルなら

```
=G$3+G$4*E10+G$5*E10^2
```

とする。$マークを使って a, b, c のセルがずれないようにして、コピーし、  
全ての x値 に対応した値が表示されるようにする。(上記 G列 オレンジ)  

データと関数の値はグラフに表示すると良いだろう。

この時点で、a, b, c の値を変えると、関数の値が変化することを確認しておく。

## 評価値

関数がどのくらいデータと合っているかを示す値を「評価値」という。  
多くの場合、評価値には「残差2乗和」が使われる。  
残差2乗和とは、それぞれのデータ点における、関数の値とデータの値の差 の2乗 を  
全てのデータ点で合計した値である。

残差2乗和が小さいほど、関数がデータによく合っているといえる。  
(もし、完全にあっていれば 0 になる)

<img src=img/sol3.png width=600>

関数の値 (上記 G列 オレンジ) のとなり (H列 グレー) に 残差 (関数の値とデータの差) の2乗を表示させる。  
例えば、上記 H9 セルなら

```
=(G9-F9)^2
```

コピーを使い、すべてのデータ点について 残差2乗 を表示させる。
さらに、 H7 セルに、残差2乗の合計 (残差2乗和) を表示させる。

```
=SUM(H9**H19)
```

<img src=img/sol4.png width=600>

これで、H7 セルの値ができるだけ小さくなるように a, b, c の値を変えていけば  
よりよいフィッティングが得られる状態になった。

<img src=img/sol5.png width=600>

## ソルバーのインストール

エクセルにはこの操作を自動で行う機能「ソルバー」が備わっている。

ソルバーは通常、無効になっているので、次の手順で使えるようにする。

1. エクセル、メニューの [ファイル]-[オプション] (一番下) を押して オプション・ウィンドウを表示させる

<img src=img/sol6.png width=600>

1. 左メニュー [アドイン]、画面下 [Excel アドイン] を選択し、[設定...] を押す

<img src=img/sol7.png width=400>

1. [ソルバーアドイン] に チェックを入れ、[OK]
2. エクセル、メニュー [データ] タブの 右端 に [ソルバー] ボタンが現れ、ソルバーが使えるようになる

## ソルバーの使い方

<img src=img/sol9.png width=600>

- **目的セルの設定** 評価値のセルを指定 (H7) 矢印ボタンを押せばワークシートから指定できる
- **目標値** [最小値] を指定
- **変数セルの変更** 変えたいセルを指定 複数指定可能 (現在の例だと a, b, c G3::G5) Ctrlキーを使えば、離れたセルモ複数指定できる
- **制約のない変数を非負数にする** 通常 OFF にする
- **解決方法の選択** [GRG 非線形] (そのまま)

上記の設定で、ソルバーは [目的セル] の値が [最小] になるよう、[変数セル] の値を変えて最適化してくれる

設定ができたら [OK] を押す

 
<img src=img/sol5.png width=600>







